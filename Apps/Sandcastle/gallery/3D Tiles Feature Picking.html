<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <!-- Use Chrome Frame in IE -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <meta name="description" content="Pick features in a 3D Tiles tileset." />
    <meta name="cesium-sandcastle-labels" content="Showcases, 3D Tiles" />
    <title>Cesium Demo</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script
      type="text/javascript"
      src="../../../Build/Cesium/Cesium.js"

    ></script>
    <script type="module" src="../load-cesium-es6.js"></script>
</head>

<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
    <style>
        @import url(../templates/bucket.css);
    </style>
    <div id="cesiumContainer" class="fullSize"></div>
    <div id="loadingOverlay">
        <h1>Loading...</h1>
    </div>
    <div id="toolbar">
        <table>
            <tbody>
                <tr>
                    <td>Bloom</td>
                    <td><input type="checkbox" data-bind="checked: show"></td>
                </tr>
                <tr>
                    <td>Glow only</td>
                    <td><input type="checkbox" data-bind="checked: glowOnly"></td>
                </tr>
                <tr>
                    <td>Threshold</td>
                    <td><input type="range" min="0.0" max="1.0" step="0.01"
                            data-bind="value: threshold, valueUpdate: 'input'"></td>
                </tr>
                <tr>
                    <td>Delta</td>
                    <td><input type="range" min="1" max="5" step="0.01"
                            data-bind="value: delta, valueUpdate: 'input'" /></td>
                </tr>
                <tr>
                    <td>Sigma</td>
                    <td><input type="range" min="1" max="10" step="0.01"
                            data-bind="value: sigma, valueUpdate: 'input'" /></td>
                </tr>
                <tr>
                    <td>Step Size</td>
                    <td><input type="range" min="0" max="7" step="0.01"
                            data-bind="value: stepSize, valueUpdate: 'input'" /></td>
                </tr>
            </tbody>
        </table>
    </div>
    <script id="cesium_sandcastle_script">

        function startup(Cesium) {
            'use strict';
            //Sandcastle_Begin
            // A simple demo of 3D Tiles feature picking with hover and select behavior
            // Building data courtesy of NYC OpenData portal: http://www1.nyc.gov/site/doitt/initiatives/3d-building.page
            var viewer = new Cesium.Viewer('cesiumContainer', {
                shouldAnimate: true,
            });
            var scene = viewer.scene
            const baseUrl = '../../SampleData/Cesium3DTiles/Tilesets/Private/'

            const addTile = (path, color = 'rgba(7000,7000,7000,7000)', zoomTo = false) => {
                path = baseUrl  +path
                const tileset = new Cesium.Cesium3DTileset({ url: path });
                tileset.style = new Cesium.Cesium3DTileStyle({
                    color
                });
                viewer.scene.primitives.add(tileset)

                if(zoomTo) viewer.zoomTo(tileset)
                return tileset
            }

            // const tileset = addTile('DX/tileset.json', 'rgba(700,700,700,700)')

            // addTile('SWJZ/tileset.json')
            // addTile(`JZ/1/F1/tileset.json`, '', true)
            // for(let i = 1; i < 5; i++){
            //     for(let j =2; j < 27; j++) {
            //         addTile(`JZ/${i}/F${j}/tileset.json`)
            //     }
                
            // }

            // addTile(`XP/XP/tileset.json`)
            // addTile(`XP/qiche/tileset.json`)
            // addTile(`XP/shiwaitingchewei/tileset.json`)
            // addTile(`XP/shiwaiyouchetingchewei/tileset.json`)
            
            // addTile(`LK/suoyou/tileset.json`,'rgba(10,770,770,7)', true)
            // addTile(`LK/jianzhu/tileset.json`,'rgba(7000,1000,70000,1000)', true)
            // addTile(`LK/luya/tileset.json`,'rgba(7000,1000,7000,7000)')
            // addTile(`LK/pudi/tileset.json`,'rgba(7000,1000,7000,7000)')
            

            var position = Cesium.Cartesian3.fromDegrees(-123.0744619, 44.0503706, 0);
            var url = '../../SampleData/models/jiangxi.glb';
            viewer.trackedEntity = viewer.entities.add({
                name : url,
                position : position,
                model : {
                    uri : url,
                    color: new Cesium.Color(1., 1., 1., 1)
                }
            });
            // url = '../../SampleData/models/jxbwg/scene.gltf';
            url = '../../SampleData/models/bwg/ch.gltf';
            viewer.entities.add({
                name : url,
                position : position,
                model : {
                    uri : url,
                    color: new Cesium.Color(70,70,70,70)
                }
            });
            url = '../../SampleData/models/bwg/ding.gltf';
            viewer.entities.add({
                name : url,
                position : position,
                model : {
                    uri : url,
                    color: new Cesium.Color(0,.5,.9,.8)
                }
            });
            url = '../../SampleData/models/bwg/jz.gltf';
            viewer.entities.add({
                name : url,
                position : position,
                model : {
                    uri : url,
                    color: new Cesium.Color(0,0,0,1.)
                }
            });
            url = '../../SampleData/models/bwg/dx.gltf';
            viewer.entities.add({
                name : url,
                position : Cesium.Cartesian3.fromDegrees(-123.0744619, 44.0503706),
                model : {
                    uri : url,
                    // lightColor: new Cesium.Cartesian3(.3,.5,.3)
                }
            });


            var directionalLight = new Cesium.DirectionalLight({
                direction : viewer.scene.camera.directionWC,
                color: new Cesium.Color(1.,1.,1.,1.),

                intensity: 10.5
            });
            viewer.scene.light = directionalLight

            // var tileset1 = new Cesium.Cesium3DTileset({ url: path });
            // tileset1.lightColor  = Cesium.Cartesian3.fromArray([1.1 ,.1 ,.4])
            // var translation = Cesium.Cartesian3.fromArray([38,28,0]);
            // tileset1.modelMatrix = Cesium.Matrix4.fromTranslation(translation);
            // viewer.scene.primitives.add(tileset1);
            var viewModel = {
                show: true,
                glowOnly: false,
                threshold: 1.,
                delta: 1.32,
                sigma: 3.78,
                stepSize: 1.04,

            };
            Cesium.knockout.track(viewModel);
            var toolbar = document.getElementById('toolbar');
            Cesium.knockout.applyBindings(viewModel, toolbar);
            for (var name in viewModel) {
                if (viewModel.hasOwnProperty(name)) {
                    Cesium.knockout.getObservable(viewModel, name).subscribe(updatePostProcess);
                }
            }
            viewer.scene.highDynamicRange = true;
            var PartialBloom = {
                contents: [],
                partialBloom: undefined,
                bloom: function(tileset, scene) {
                    if (!this.partialBloom) this.partialBloom = scene.postProcessStages.add(Cesium.PostProcessStageLibrary.partialBloomStage());

                    function getContents(root) {

                        if (root.content instanceof Cesium.Empty3DTileContent) {
                            // do nothing
                        } else if (root.content && (root.content._model || root.content.featuresLength)) {
                            if (root.content.featuresLength) {
                                for (var i = 0; i < root.content.featuresLength; ++i) {
                                    var feature = root.content.getFeature(i);
                                    PartialBloom.contents.push(feature)
                                }

                            }
                            else PartialBloom.contents.push(root.content._model)
                        }
                        //recurse
                        root.children.map(v => getContents(v))
                    }

                    var setBloom = function() {
                        if (!tileset.loaded) {
                            getContents(tileset.root)
                            PartialBloom.partialBloom.selected = PartialBloom.contents
                            tileset.loaded = true
                        }

                    }

                    // tileset.allTilesLoaded.addEventListener(setBloom);
                }
            }
            // PartialBloom.bloom(viewer.trackedEntity, viewer.scene)
            PartialBloom.bloom('tileset', viewer.scene)

            function updatePostProcess() {
                PartialBloom.partialBloom.enabled = Boolean(viewModel.show);
                PartialBloom.partialBloom.uniforms.glowOnly = Boolean(viewModel.glowOnly);
                PartialBloom.partialBloom.uniforms.threshold = Number(viewModel.threshold);
                PartialBloom.partialBloom.uniforms.delta = Number(viewModel.delta);
                PartialBloom.partialBloom.uniforms.sigma = Number(viewModel.sigma);
                PartialBloom.partialBloom.uniforms.stepSize = Number(viewModel.stepSize);
            }
            updatePostProcess()
            viewer.scene.postProcessStages.fxaa.enabled = true;
            // tileset.allTilesLoaded.addEventListener(addRect);


            function addRect() {
                viewer.scene.usePartial = true
                var rectangle = viewer.scene.primitives.add(new Cesium.Primitive({
                    geometryInstances: new Cesium.GeometryInstance({
                        geometry: new Cesium.RectangleGeometry({
                            rectangle: Cesium.Rectangle.fromCartesianArray(Cesium.Cartesian3.fromRadiansArray([-1.3194369277314022, 0.6988062530900625, -1.3193955980204217, 0.6988091578771254, -1.3193931220959367, 0.698743632490865, -1.3194358224045408, 0.6987471965556998])),
                            vertexFormat: Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT
                        })
                    }),
                    appearance: new Cesium.EllipsoidSurfaceAppearance({
                        aboveGround: true
                    })
                }));

                rectangle.appearance.material = new Cesium.Material({
                    fabric: {
                        type: 'Image',
                        uniforms: {
                            // image: new Cesium.Texture({context: viewer.scene.context, width:1, height: 1}).copyFrom({
                            //     width: 1,
                            //     height: 1,
                            //     arrayBufferView: new Uint8Array([255, 255, 0, 255])
                            // })
                            image: viewer.scene.view.sceneFramebuffer.getPartialFramebuffer().getColorTexture(0)
                        }
                    }
                });
                // rectangle.appearance.material = new Cesium.Material({
                //     fabric: {
                //         type: 'Water',
                //         uniforms: {
                //             specularMap: '../images/water-specular.png',
                //             normalMap: Cesium.buildModuleUrl('Assets/Textures/waterNormalsSmall.jpg'),
                //             baseWaterColor: new Cesium.Color(0., 0.4, 0.6, 1.),
                //             frequency: 2000.0,
                //             animationSpeed: 0.04,
                //             amplitude: 2.0
                //         }
                //     }
                // });
            }

            //Sandcastle_End
            Sandcastle.finishedLoading();
        }
        if (typeof Cesium !== 'undefined') {
            window.startupCalled = true;
            startup(Cesium);
        }
    </script>
</body>

</html>
